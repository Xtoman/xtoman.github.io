name: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram –æ –Ω–æ–≤–æ–º –ø–æ—Å—Ç–µ

on:
  push:
    branches:
      - main
      - master
    paths:
      - '_posts/**/*.md'
  workflow_dispatch:
    inputs:
      test_post:
        description: '–ü—É—Ç—å –∫ —Ç–µ—Å—Ç–æ–≤–æ–º—É –ø–æ—Å—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: _posts/2025-09-18-what_i_read_in_2025.md)'
        required: false
        default: ''

jobs:
  notify-telegram:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Python
        run: |
          pip install pyyaml requests

      - name: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          BLOG_URL: ${{ secrets.BLOG_URL || 'https://xtoman.ru' }}
          TEST_POST: ${{ inputs.test_post }}
        run: |
          python3 << 'EOF'
          import os
          import re
          import subprocess
          import yaml
          import requests
          from pathlib import Path

          # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
          BOT_TOKEN = os.environ.get('TELEGRAM_BOT_TOKEN')
          CHAT_ID = os.environ.get('TELEGRAM_CHAT_ID')
          BLOG_URL = os.environ.get('BLOG_URL', 'https://xtoman.ru')

          if not BOT_TOKEN or not CHAT_ID:
              print("‚ùå –ù–µ –∑–∞–¥–∞–Ω—ã TELEGRAM_BOT_TOKEN –∏–ª–∏ TELEGRAM_CHAT_ID")
              exit(1)

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞
          test_post = os.environ.get('TEST_POST', '')
          
          new_posts = []
          
          if test_post:
              # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–æ—Å—Ç
              print(f"üß™ –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ—Å—Ç {test_post}")
              if Path(test_post).exists():
                  new_posts = [test_post]
              else:
                  print(f"‚ùå –£–∫–∞–∑–∞–Ω–Ω—ã–π –ø–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω: {test_post}")
                  exit(1)
          else:
              # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ - –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤—ã–µ –ø–æ—Å—Ç—ã
              # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ HEAD~1
              check_parent = subprocess.run(
                  ['git', 'rev-parse', '--verify', 'HEAD~1'],
                  capture_output=True,
                  text=True,
                  cwd=os.getcwd()
              )
              
              if check_parent.returncode == 0:
                  # –ï—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–º–º–∏—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º diff
                  result = subprocess.run(
                      ['git', 'diff', '--name-only', '--diff-filter=A', 'HEAD~1', 'HEAD'],
                      capture_output=True,
                      text=True,
                      cwd=os.getcwd()
                  )
                  new_files = result.stdout.strip().split('\n')
                  new_posts = [f for f in new_files if f.startswith('_posts/') and f.endswith('.md')]
              
              if not new_posts:
                  # –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —á–µ—Ä–µ–∑ diff, –∏—Å–ø–æ–ª—å–∑—É–µ–º git show –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–º–º–∏—Ç–∞
                  result = subprocess.run(
                      ['git', 'show', '--name-only', '--pretty=format:', '--diff-filter=A', 'HEAD'],
                      capture_output=True,
                      text=True,
                      cwd=os.getcwd()
                  )
                  all_files = result.stdout.strip().split('\n')
                  new_posts = [f for f in all_files if f.startswith('_posts/') and f.endswith('.md')]
              
              # –§–∏–ª—å—Ç—Ä—É–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
              new_posts = [p for p in new_posts if p.strip()]

          for post_file in new_posts:
              if not post_file:
                  continue
              
              post_path = Path(post_file)
              if not post_path.exists():
                  continue

              print(f"üìù –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞: {post_file}")

              # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –ø–æ—Å—Ç–∞
              content = post_path.read_text(encoding='utf-8')

              # –ü–∞—Ä—Å–∏–º frontmatter
              frontmatter_match = re.match(r'^---\s*\n(.*?)\n---\s*\n(.*)$', content, re.DOTALL)
              
              if not frontmatter_match:
                  print(f"‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å frontmatter –≤ {post_file}")
                  continue

              frontmatter_str = frontmatter_match.group(1)
              try:
                  frontmatter = yaml.safe_load(frontmatter_str)
              except Exception as e:
                  print(f"‚ö†Ô∏è  –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ YAML –≤ {post_file}: {e}")
                  continue

              # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ
              title = frontmatter.get('title', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')
              description = frontmatter.get('description', '')
              date = frontmatter.get('date', '')
              
              # –§–æ—Ä–º–∏—Ä—É–µ–º URL –ø–æ—Å—Ç–∞
              # –ò–º—è —Ñ–∞–π–ª–∞ –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
              post_name = post_path.stem
              # –§–æ—Ä–º–∞—Ç: YYYY-MM-DD-title
              date_match = re.match(r'^(\d{4}-\d{2}-\d{2})-(.+)$', post_name)
              if date_match:
                  year, month, day = date_match.group(1).split('-')
                  title_slug = date_match.group(2)
                  post_url = f"{BLOG_URL}/{year}/{month}/{day}/{title_slug}/"
              else:
                  post_url = f"{BLOG_URL}"

              # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
              message = f"‚ú® <b>–ù–æ–≤—ã–π –ø–æ—Å—Ç –≤ –±–ª–æ–≥–µ!</b>\n\n"
              message += f"üìå <b>{title}</b>\n\n"
              
              if description:
                  # –û–±—Ä–µ–∑–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ 200 —Å–∏–º–≤–æ–ª–æ–≤
                  desc_short = description[:200] + "..." if len(description) > 200 else description
                  message += f"{desc_short}\n\n"
              
              if date:
                  message += f"üìÖ {date}\n\n"
              
              message += f"üîó <a href='{post_url}'>–ß–∏—Ç–∞—Ç—å –¥–∞–ª–µ–µ ‚Üí</a>"

              # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
              url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
              payload = {
                  'chat_id': CHAT_ID,
                  'text': message,
                  'parse_mode': 'HTML',
                  'disable_web_page_preview': False
              }

              try:
                  response = requests.post(url, json=payload, timeout=10)
                  response.raise_for_status()
                  print(f"‚úÖ –ê–Ω–æ–Ω—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram: {title}")
              except Exception as e:
                  print(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram –¥–ª—è –ø–æ—Å—Ç–∞ '{title}': {e}")
                  if hasattr(e, 'response') and e.response is not None:
                      print(f"   –û—Ç–≤–µ—Ç API: {e.response.text}")

          if not new_posts:
              print("‚ÑπÔ∏è  –ù–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ")
          else:
              print(f"‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ø–æ—Å—Ç–æ–≤: {len(new_posts)}")

          EOF
        continue-on-error: true

